<html xmlns:v="urn:schemas-microsoft-com:vml"
xmlns:o="urn:schemas-microsoft-com:office:office"
xmlns:w="urn:schemas-microsoft-com:office:word"
xmlns="http://www.w3.org/TR/REC-html40">

<head>
<meta http-equiv=Content-Type content="text/html; charset=windows-1252">
<meta name=ProgId content=Word.Document>
<meta name=Generator content="Microsoft Word 11">
<meta name=Originator content="Microsoft Word 11">
<link rel=File-List href="cancel_files/filelist.xml">
<title>CANCEL</title>
<!--[if gte mso 9]><xml>
 <w:WordDocument>
  <w:Zoom>BestFit</w:Zoom>
  <w:SpellingState>Clean</w:SpellingState>
  <w:GrammarState>Clean</w:GrammarState>
  <w:ValidateAgainstSchemas/>
  <w:SaveIfXMLInvalid>false</w:SaveIfXMLInvalid>
  <w:IgnoreMixedContent>false</w:IgnoreMixedContent>
  <w:AlwaysShowPlaceholderText>false</w:AlwaysShowPlaceholderText>
  <w:BrowserLevel>MicrosoftInternetExplorer4</w:BrowserLevel>
 </w:WordDocument>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:LatentStyles DefLockedState="false" LatentStyleCount="156">
 </w:LatentStyles>
</xml><![endif]-->
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:Verdana;
	panose-1:2 11 6 4 3 5 4 4 2 4;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-pitch:variable;
	mso-font-signature:536871559 0 0 0 415 0;}
@font-face
	{font-family:"MS Sans Serif";
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-alt:"Times New Roman";
	mso-font-charset:0;
	mso-generic-font-family:roman;
	mso-font-format:other;
	mso-font-pitch:auto;
	mso-font-signature:0 0 0 0 0 0;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{mso-style-parent:"";
	margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";}
h2
	{mso-margin-top-alt:auto;
	margin-right:0in;
	mso-margin-bottom-alt:auto;
	margin-left:0in;
	mso-pagination:widow-orphan;
	mso-outline-level:2;
	font-size:18.0pt;
	font-family:"Times New Roman";
	font-weight:bold;}
h3
	{mso-margin-top-alt:auto;
	margin-right:0in;
	mso-margin-bottom-alt:auto;
	margin-left:0in;
	mso-pagination:widow-orphan;
	mso-outline-level:3;
	font-size:13.5pt;
	font-family:"Times New Roman";
	font-weight:bold;}
h4
	{mso-margin-top-alt:auto;
	margin-right:0in;
	mso-margin-bottom-alt:auto;
	margin-left:0in;
	mso-pagination:widow-orphan;
	mso-outline-level:4;
	font-size:12.0pt;
	font-family:"Times New Roman";
	font-weight:bold;}
a:link, span.MsoHyperlink
	{color:blue;
	text-decoration:underline;
	text-underline:single;}
a:visited, span.MsoHyperlinkFollowed
	{color:purple;
	text-decoration:underline;
	text-underline:single;}
p
	{mso-margin-top-alt:auto;
	margin-right:0in;
	mso-margin-bottom-alt:auto;
	margin-left:0in;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";}
pre
	{margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
	font-size:10.0pt;
	font-family:"Courier New";
	mso-fareast-font-family:"Times New Roman";}
span.SpellE
	{mso-style-name:"";
	mso-spl-e:yes;}
span.GramE
	{mso-style-name:"";
	mso-gram-e:yes;}
@page Section1
	{size:8.5in 11.0in;
	margin:1.0in 1.25in 1.0in 1.25in;
	mso-header-margin:.5in;
	mso-footer-margin:.5in;
	mso-paper-source:0;}
div.Section1
	{page:Section1;}
-->
</style>
<!--[if gte mso 10]>
<style>
 /* Style Definitions */
 table.MsoNormalTable
	{mso-style-name:"Table Normal";
	mso-tstyle-rowband-size:0;
	mso-tstyle-colband-size:0;
	mso-style-noshow:yes;
	mso-style-parent:"";
	mso-padding-alt:0in 5.4pt 0in 5.4pt;
	mso-para-margin:0in;
	mso-para-margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:10.0pt;
	font-family:"Times New Roman";
	mso-ansi-language:#0400;
	mso-fareast-language:#0400;
	mso-bidi-language:#0400;}
</style>
<![endif]-->
<meta name=Template content="C:\PROGRAM FILES\MICROSOFT OFFICE\OFFICE\html.dot">
<!--[if gte mso 9]><xml>
 <o:shapedefaults v:ext="edit" spidmax="3074"/>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <o:shapelayout v:ext="edit">
  <o:idmap v:ext="edit" data="1"/>
 </o:shapelayout></xml><![endif]-->
</head>

<body bgcolor=white lang=EN-US link=blue vlink=purple style='tab-interval:.5in'
leftmargin=8>

<div class=Section1>

<h2><a name=MYSAMPLE><span style='font-family:Verdana'>CANCEL</span></a><span
style='font-family:Verdana'> <o:p></o:p></span></h2>

<h3><span style='font-family:Verdana'>SUMMARY<o:p></o:p></span></h3>

<p><span style='font-size:10.0pt;font-family:Verdana'>This sample demonstrates
the use of <span class=GramE>new <span style='mso-spacerun:yes'> </span>cancel</span>-safe
queue (<span class=SpellE>IoCsqInitialize</span>, <span class=SpellE>IoCsqInsertIrp</span>,
<span class=SpellE>IoCsqRemoveIrp</span>, <span class=SpellE>IoCsqRemoveNextIrp</span>)
APIs introduced on Windows XP for queuing <span class=SpellE>IRPs</span> in the
driver's internal device queue. By using these APIs, driver writers do not have
to worry about any IRP cancellation race condition issues. A common problem
with cancellation of <span class=SpellE>IRPs</span> in a driver is
synchronization between the cancel lock <span class=GramE>or</span> the <span
class=SpellE>InterlockedExchange</span> in the I/O Manager with the driver's
queue lock. These APIs abstract the cancel logic while allowing the driver to
implement the queue and associated synchronization. <o:p></o:p></span></p>

<p><span style='font-size:10.0pt;font-family:Verdana'>The sample is accompanied
by a simple multithreaded Win32 console application to stress-test the driver's
cancel and cleanup routines.<o:p></o:p></span></p>

<p><span style='font-size:10.0pt;font-family:Verdana'>This driver is written
for <span class=GramE>an</span> hypothetical data acquisition device that
requires polling at a regular interval. The device has some settling period
between two reads. Upon user request the driver reads data and records the
time. When the next read request comes in, it checks the interval to see if
it's reading the device too soon. If so, it <span class=SpellE>pends</span> the
IRP and sleeps for a while and tries again. Upon arrival, <span class=SpellE>IRPs</span>
are queued in a cancel-safe queue and a semaphore is signaled. A polling thread
waiting indefinitely on the semaphore wakes up to the signal and processes <span
class=GramE>queued</span> <span class=SpellE>IRPs</span> sequentially. <o:p></o:p></span></p>

<p><span style='font-size:10.0pt;font-family:Verdana'>This sample is adapted
from the original cancel sample
(http://support.microsoft.com/support/kb/articles/Q188/2/76.asp) written for
NT4.0. <o:p></o:p></span></p>

<p><span style='font-size:10.0pt;font-family:Verdana'>The building and
installation instructions given here apply to Windows® 2000 and later operating systems.<o:p></o:p></span></p>

<p><span style='font-size:10.0pt;font-family:Verdana'>This sample driver is not
a PnP driver. This is a minimal driver meant to demonstrate an OS feature.
Neither it nor its sample programs are intended for use in a production
environment. Rather, they are intended for educational purposes and as a
skeleton driver. <o:p></o:p></span></p>

<h3><span style='font-family:Verdana'>BUILDING THE SAMPLE<o:p></o:p></span></h3>

<p><span style='font-size:10.0pt;font-family:Verdana'>Click the Free Build
Environment or Checked Build Environment icon under Development Kits program
group to set basic environment variables. <o:p></o:p></span></p>

<p><span style='font-size:10.0pt;font-family:Verdana'>Change to the directory
containing the device source code, such as CD <span class=SpellE>Src</span>\General\Cancel.
<o:p></o:p></span></p>

<p><span style='font-size:10.0pt;font-family:Verdana'>Run <b>build -<span
class=SpellE>ceZ</span>,</b> or use the macro <b>BLD</b>. This command invokes
the Microsoft make routines to build the components. If the build </span>s<span
style='font-size:10.0pt;font-family:Verdana'>ucceeds, you will find the driver,
<span class=SpellE>cancel.sys</span>, and the test application, canclapp.exe,
in the binary output directory specified for the build environment. You can get the output path from the buildxxx.log file. If it fails you can find errors and warnings in the <span class=SpellE>buildxxx.err</span>
and <span class=SpellE>buildxxx.err</span> respectively, where xxx is either <span
class=SpellE>chk</span> or <span class=SpellE>fre</span> depending on the build
environment. <o:p></o:p></span></p>

<h3><span style='font-family:Verdana'>STARTIO IMPLEMENTATION<o:p></o:p></span></h3>

<p><span style='font-size:10.0pt;font-family:Verdana'>In the <span
class=SpellE>startio</span> directory is another version of the sample driver
that shows how to use <span class=GramE>the <span
style='mso-spacerun:yes'> </span>cancel</span>-safe queues to implement IO
queuing functionality similar to the <span class=SpellE>IoStartPacket/IoStartNextPacket</span>
APIs. The same test application works with this driver as well.</span><span
style='font-family:Verdana'><o:p></o:p></span></p>

<h3><span style='font-family:Verdana'>TESTING<o:p></o:p></span></h3>

<p><span style='font-size:10.0pt;font-family:Verdana'>To test this driver, run
Testapp.exe, a simple Win32 multithreaded console mode application. The driver
will be automatically loaded and started. When you exit the app, the driver
will stopped and removed.<o:p></o:p></span></p>

<p><span class=SpellE><span style='font-size:10.0pt;font-family:Verdana'>Usage<span
class=GramE>:testapp</span></span></span><span style='font-size:10.0pt;
font-family:Verdana'> (<span class=SpellE>NumberOfThreads</span>)<o:p></o:p></span></p>

<p><b><span style='font-size:10.0pt;font-family:Verdana'>Note</span></b><span
style='font-size:10.0pt;font-family:Verdana'>: <span class=SpellE>NumberOfThreads</span>
is limited to a maximum of 10 threads; the default value if run without the option
is 1. The main thread waits for user input. If you press Q, the application
exits gracefully; otherwise it exits the process abruptly forcing all the
threads to be terminated and all pending I/Os to be canceled. Other threads
perform I/O asynchronously in a loop. After every overlapped read, the thread
goes into an <span class=SpellE>alertable</span> sleep and wakes as soon as
completion routines is executed, when the read IRP gets completed by the
driver. You should run multiple instances of the application to stress test the
driver.<o:p></o:p></span></p>

<h3><span style='font-family:Verdana'>CODE TOUR<o:p></o:p></span></h3>

<h4><span style='font-family:Verdana'>File Manifest<o:p></o:p></span></h4>

<pre><u>File<span style='mso-tab-count:2'>           </span>Description<o:p></o:p></u></pre><pre><o:p>&nbsp;</o:p></pre><pre><span
class=GramE>Cancel.htm<span style='mso-tab-count:1'>     </span>Documentation for this sample (this file).</span></pre><pre><span
class=SpellE>Cancel.c</span><span style='mso-tab-count:1'>       </span>Source <span
class=GramE>file</span> of the sample driver.</pre><pre><span class=GramE>Sources<span
style='mso-tab-count:2'>        </span>Generic file that lists source files and all the build options.</span></pre><pre><span
class=SpellE>Testapp.c</span><span style='mso-tab-count:1'>      </span>Source <span
class=GramE>file</span> of the test application.</pre><pre><span class=SpellE>Install.c</span><span
style='mso-tab-count:1'>      </span>Contains functions to load/start/stop/remove the driver.</pre><pre><span
class=SpellE>Testapp.h</span><span style='mso-tab-count:1'>      </span>Header <span
class=GramE>file</span> for common definitions and function prototypes.</pre><pre><span
class=SpellE>Cancel.rc</span><span style='mso-tab-count:1'>      </span>Resource file that specify information such as file type, version, etc.</pre><pre><span
class=SpellE>Makefile</span><span style='mso-tab-count:1'>       </span><span
class=GramE>This file</span> merely <span class=SpellE>indirects</span> to the real <span
class=SpellE>makefile</span> that is shared by all the driver components of the Windows NT DDK.</pre>

<p align=center style='text-align:center'><a href="#top"><span
style='font-size:10.0pt;font-family:Verdana'>Top of page</span></a><span
style='font-size:10.0pt;font-family:Verdana'> <o:p></o:p></span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=624
 style='width:6.5in;mso-cellspacing:0in;mso-padding-alt:0in 5.4pt 0in 5.4pt'>
 <tr style='mso-yfti-irow:0;mso-yfti-firstrow:yes;mso-yfti-lastrow:yes;
  height:1.5pt'>
  <td style='background:aqua;padding:.75pt .75pt .75pt .75pt;height:1.5pt'>
  <p class=MsoNormal><span style='color:black'><o:p>&nbsp;</o:p></span></p>
  </td>
 </tr>
</table>

<p><span style='font-size:7.5pt;font-family:"MS Sans Serif"'>© 2004 Microsoft
Corporation</span><span style='font-size:10.0pt;font-family:Verdana'> <span
style='color:black'><o:p></o:p></span></span></p>

</div>

</body>

</html>
